{% extends "base.html" %}

{% block title %}结果页面 - Aruba License Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 系统状态卡片 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>License使用情况监控
                </h4>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>刷新数据
                    </button>
                    <span class="badge bg-secondary ms-2" id="lastUpdate">
                        <i class="fas fa-clock me-1"></i>最后更新: 未知
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <span class="status-indicator status-unknown" id="systemStatus"></span>
                            <span id="systemStatusText">系统状态: 检查中...</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <span class="text-muted">License server IP: </span>
                        <span class="fw-bold" id="controllerIp">{{ config.controller_ip or '未配置' }}</span>
                    </div>
                    <div class="col-md-3">
                        <span class="text-muted">轮询状态: </span>
                        <span class="badge" id="pollingStatus">未知</span>
                    </div>
                    <div class="col-md-3">
                        <span class="text-muted">查询间隔: </span>
                        <span id="pollingInterval">{{ config.polling_interval or 86400 }} 分钟</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- License使用情况摘要卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>License使用情况摘要
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="licenseSummary">
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-primary" id="apAvailable">-</div>
                            <div class="text-muted">AP可用</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-info" id="pefAvailable">-</div>
                            <div class="text-muted">PEF可用</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-warning" id="rfpAvailable">-</div>
                            <div class="text-muted">RFP可用</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-success" id="mmAvailable">-</div>
                            <div class="text-muted">MM可用</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-secondary" id="mcvaAvailable">-</div>
                            <div class="text-muted">MC-VA-RW可用</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <div class="h4 text-dark" id="totalClients">-</div>
                            <div class="text-muted">总客户端数</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- License信息卡片 -->
        <div id="licenseCards" class="row">
            {% if license_data %}
                
                <!-- 显示各个License池的信息 -->
                {% if license_data.license_usage %}
                    {% for pool_name, pool_data in license_data.license_usage.items() %}
                        {% if pool_name.startswith('License Clients License Usage for pool') %}
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-database me-2"></i>{{ pool_name }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>主机名</th>
                                                    <th>IP地址</th>
                                                    <th>AP</th>
                                                    <th>PEF</th>
                                                    <th>RF Protect</th>
                                                    <th>MM</th>
                                                    <th>MC-VA-RW</th>
                                                    <th>告警门限</th>
                                                    <th>邮件通知</th>
                                                    <th>Syslog通知</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for client in pool_data %}
                                                    {% if client.Hostname != 'TOTAL' %}
                                                        <tr data-hostname="{{ client.Hostname }}">
                                                            <td class="fw-bold">{{ client.Hostname or 'N/A' }}</td>
                                                            <td>{{ client['IP Address'] or 'N/A' }}</td>
                                                            <td>
                                                                <span class="badge bg-primary" id="ap-{{ client.Hostname }}">{{ client.AP or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-info">{{ client.PEF or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-warning">{{ client['RF Protect'] or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-success">{{ client.MM or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-secondary">{{ client['MC-VA-RW'] or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <input type="number" class="form-control form-control-sm threshold-input" 
                                                                       id="threshold-{{ client.Hostname }}" 
                                                                       value="0" min="0" style="width: 80px;">
                                                            </td>
                                                            <td>
                                                                <div class="form-check">
                                                                    <input class="form-check-input email-notification" 
                                                                           type="checkbox" 
                                                                           id="email-{{ client.Hostname }}"
                                                                           data-hostname="{{ client.Hostname }}">
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="form-check">
                                                                    <input class="form-check-input syslog-notification" 
                                                                           type="checkbox" 
                                                                           id="syslog-{{ client.Hostname }}"
                                                                           data-hostname="{{ client.Hostname }}">
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% else %}
                                                        <tr class="table-info">
                                                            <td class="fw-bold">总计</td>
                                                            <td>-</td>
                                                            <td>
                                                                <span class="badge bg-primary">{{ client.AP or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-info">{{ client.PEF or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-warning">{{ client['RF Protect'] or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-success">{{ client.MM or 0 }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-secondary">{{ client['MC-VA-RW'] or 0 }}</span>
                                                            </td>
                                                            <td>-</td>
                                                            <td>-</td>
                                                            <td>-</td>
                                                        </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% else %}
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                            <h4 class="text-muted">暂无License数据</h4>
                            <p class="text-muted">请先配置License Server信息，然后点击刷新按钮获取数据</p>
                            <a href="{{ url_for('config_page') }}" class="btn btn-primary">
                                <i class="fas fa-cog me-2"></i>前往配置页面
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- 状态提示 -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">系统提示</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            数据已刷新
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化页面
    updateSystemStatus();
    startAutoRefresh();
    
    // 每60秒更新一次系统状态
    setInterval(updateSystemStatus, 60000);
    
    // 初始化告警检查
    initializeAlertSystem();
    
    // 初始化License摘要
    console.log('开始初始化License摘要...');
    updateLicenseSummary();
});

// 更新系统状态
function updateSystemStatus() {
    axios.get('/api/status')
        .then(response => {
            const data = response.data;
            const systemStatus = document.getElementById('systemStatus');
            const systemStatusText = document.getElementById('systemStatusText');
            const pollingStatus = document.getElementById('pollingStatus');
            
            // 更新系统状态
            if (data.config_loaded) {
                systemStatus.className = 'status-indicator status-online';
                systemStatusText.textContent = '系统状态: 在线';
            } else {
                systemStatus.className = 'status-indicator status-offline';
                systemStatusText.textContent = '系统状态: 离线';
            }
            
            // 更新轮询状态
            if (data.polling_active) {
                pollingStatus.className = 'badge bg-success';
                pollingStatus.textContent = '运行中';
            } else {
                pollingStatus.className = 'badge bg-secondary';
                pollingStatus.textContent = '已停止';
            }
            
            // 更新最后更新时间
            if (data.last_update) {
                const lastUpdate = document.getElementById('lastUpdate');
                const updateTime = new Date(data.last_update).toLocaleString('zh-CN');
                lastUpdate.innerHTML = `<i class="fas fa-clock me-1"></i>最后更新: ${updateTime}`;
            }
        })
        .catch(error => {
            console.error('获取系统状态失败:', error);
            const systemStatus = document.getElementById('systemStatus');
            const systemStatusText = document.getElementById('systemStatusText');
            systemStatus.className = 'status-indicator status-offline';
            systemStatusText.textContent = '系统状态: 连接失败';
        });
}

// 刷新数据
function refreshData() {
    const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
    const icon = refreshBtn.querySelector('i');
    
    // 显示加载状态
    icon.className = 'fas fa-sync-alt fa-spin me-1';
    refreshBtn.disabled = true;
    
        axios.post('/api/refresh')
            .then(response => {
                if (response.data.status === 'success') {
                    showToast('数据刷新成功', 'success');
                    
                    // 获取最新数据并检查告警
                    axios.get('/api/license')
                        .then(licenseResponse => {
                            if (licenseResponse.data.status === 'success') {
                                checkAlerts(licenseResponse.data.data);
                                // 更新License摘要
                                calculateLicenseSummary(licenseResponse.data.data);
                            }
                        })
                        .catch(error => {
                            console.error('获取License数据失败:', error);
                        });
                    
                    // 重新加载页面以显示最新数据
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast('刷新失败: ' + response.data.message, 'error');
                }
            })
            .catch(error => {
                showToast('刷新失败: ' + error.message, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                icon.className = 'fas fa-sync-alt me-1';
                refreshBtn.disabled = false;
            });
}

// 自动刷新
function startAutoRefresh() {
    // 每5分钟自动刷新一次
    refreshInterval = setInterval(() => {
        updateSystemStatus();
    }, 300000);
}

// 显示提示消息
function showToast(message, type) {
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    const toast = new bootstrap.Toast(document.getElementById('statusToast'));
    toast.show();
}

// 初始化告警系统
function initializeAlertSystem() {
    console.log('初始化告警系统');
    
    // 加载已保存的告警设置
    loadAlertSettings();
    
    // 绑定告警门限输入事件
    document.querySelectorAll('.threshold-input').forEach(input => {
        input.addEventListener('change', function() {
            const hostname = this.id.replace('threshold-', '');
            console.log(`设置 ${hostname} 的告警门限为: ${this.value}`);
            saveAlertSettings(hostname);
        });
    });
    
    // 绑定通知复选框事件
    document.querySelectorAll('.email-notification, .syslog-notification').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const hostname = this.dataset.hostname;
            const type = this.classList.contains('email-notification') ? '邮件' : 'Syslog';
            console.log(`${hostname} 的${type}通知: ${this.checked ? '启用' : '禁用'}`);
            saveAlertSettings(hostname);
        });
    });
}

// 加载告警设置
function loadAlertSettings() {
    console.log('加载告警设置...');
    
    axios.get('/api/get-alert-settings')
        .then(response => {
            if (response.data.status === 'success') {
                const settings = response.data.data;
                console.log('已保存的告警设置:', settings);
                
                // 应用设置到页面
                for (const [hostname, setting] of Object.entries(settings)) {
                    const thresholdInput = document.getElementById(`threshold-${hostname}`);
                    const emailCheckbox = document.getElementById(`email-${hostname}`);
                    const syslogCheckbox = document.getElementById(`syslog-${hostname}`);
                    
                    if (thresholdInput) {
                        thresholdInput.value = setting.threshold || 0;
                    }
                    if (emailCheckbox) {
                        emailCheckbox.checked = setting.email_enabled || false;
                    }
                    if (syslogCheckbox) {
                        syslogCheckbox.checked = setting.syslog_enabled || false;
                    }
                }
            }
        })
        .catch(error => {
            console.error('加载告警设置失败:', error);
        });
}

// 保存告警设置
function saveAlertSettings(hostname) {
    const thresholdInput = document.getElementById(`threshold-${hostname}`);
    const emailCheckbox = document.getElementById(`email-${hostname}`);
    const syslogCheckbox = document.getElementById(`syslog-${hostname}`);
    
    if (!thresholdInput || !emailCheckbox || !syslogCheckbox) {
        console.error(`找不到 ${hostname} 的告警设置元素`);
        return;
    }
    
    const alertData = {
        hostname: hostname,
        threshold: thresholdInput.value,
        email_enabled: emailCheckbox.checked,
        syslog_enabled: syslogCheckbox.checked
    };
    
    console.log(`保存告警设置: ${hostname}`, alertData);
    
    axios.post('/api/save-alert-settings', alertData)
        .then(response => {
            if (response.data.status === 'success') {
                console.log(`告警设置保存成功: ${hostname}`);
            } else {
                console.error(`告警设置保存失败: ${response.data.message}`);
                showToast(`告警设置保存失败: ${response.data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('保存告警设置失败:', error);
            showToast(`保存告警设置失败: ${error.message}`, 'error');
        });
}

// 检查告警条件
function checkAlerts(licenseData) {
    if (!licenseData) return;
    
    console.log('检查告警条件...');
    
    // 遍历所有License池
    for (const [poolName, poolData] of Object.entries(licenseData)) {
        if (poolName.startsWith('License Clients License Usage for pool')) {
            poolData.forEach(client => {
                if (client.Hostname && client.Hostname !== 'TOTAL') {
                    checkClientAlert(client);
                }
            });
        }
    }
}

// 检查单个客户端的告警
function checkClientAlert(client) {
    const hostname = client.Hostname;
    const apValue = parseInt(client.AP || 0);
    
    // 从保存的设置中获取告警配置
    getAlertSettingsForHost(hostname).then(settings => {
        if (!settings) return;
        
        const threshold = settings.threshold || 0;
        
        // 检查是否超过门限
        if (apValue > threshold && threshold > 0) {
            console.log(`告警: ${hostname} 的AP值 ${apValue} 超过门限 ${threshold}`);
            
            // 根据保存的设置发送通知
            if (settings.email_enabled) {
                sendEmailAlert(hostname, apValue, threshold);
            }
            
            if (settings.syslog_enabled) {
                sendSyslogAlert(hostname, apValue, threshold);
            }
            
            // 高亮显示告警行
            const row = document.querySelector(`tr[data-hostname="${hostname}"]`);
            if (row) {
                row.classList.add('table-danger');
                setTimeout(() => {
                    row.classList.remove('table-danger');
                }, 5000);
            }
        }
    });
}

// 获取特定主机的告警设置
function getAlertSettingsForHost(hostname) {
    return new Promise((resolve) => {
        axios.get('/api/get-alert-settings')
            .then(response => {
                if (response.data.status === 'success') {
                    const settings = response.data.data;
                    resolve(settings[hostname] || null);
                } else {
                    resolve(null);
                }
            })
            .catch(error => {
                console.error('获取告警设置失败:', error);
                resolve(null);
            });
    });
}

// 发送邮件告警
function sendEmailAlert(hostname, apValue, threshold) {
    console.log(`发送邮件告警: ${hostname} - AP: ${apValue}, 门限: ${threshold}`);
    
    const alertData = {
        hostname: hostname,
        ap_value: apValue,
        threshold: threshold,
        alert_type: 'email'
    };
    
    axios.post('/api/send-alert', alertData)
        .then(response => {
            if (response.data.status === 'success') {
                showToast(`邮件告警已发送: ${hostname}`, 'success');
            } else {
                showToast(`邮件告警发送失败: ${response.data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('邮件告警发送失败:', error);
            showToast(`邮件告警发送失败: ${error.message}`, 'error');
        });
}

// 发送Syslog告警
function sendSyslogAlert(hostname, apValue, threshold) {
    console.log(`发送Syslog告警: ${hostname} - AP: ${apValue}, 门限: ${threshold}`);
    
    const alertData = {
        hostname: hostname,
        ap_value: apValue,
        threshold: threshold,
        alert_type: 'syslog'
    };
    
    axios.post('/api/send-alert', alertData)
        .then(response => {
            if (response.data.status === 'success') {
                showToast(`Syslog告警已发送: ${hostname}`, 'success');
            } else {
                showToast(`Syslog告警发送失败: ${response.data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('Syslog告警发送失败:', error);
            showToast(`Syslog告警发送失败: ${error.message}`, 'error');
        });
}

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

// 更新License摘要
function updateLicenseSummary() {
    console.log('updateLicenseSummary函数被调用');
    
    axios.get('/api/license')
        .then(response => {
            console.log('API响应:', response.data);
            
            if (response.data.status === 'success') {
                const data = response.data.data;
                console.log('开始计算License摘要...');
                calculateLicenseSummary(data);
            } else {
                console.error('API响应失败:', response.data.message);
            }
        })
        .catch(error => {
            console.error('获取License数据失败:', error);
        });
}

// 计算License摘要
function calculateLicenseSummary(data) {
    try {
        // 获取license_usage数据
        const licenseUsage = data.license_usage || {};
        const licenseSummary = data.license_summary || {};
        
        // 计算总使用量
        let totalApUsed = 0;
        let totalPefUsed = 0;
        let totalRfpUsed = 0;
        let totalMmUsed = 0;
        let totalMcvaUsed = 0;
        let totalClients = 0;
        
        // 遍历所有池的使用情况
        for (const poolName in licenseUsage) {
            if (poolName.startsWith('License Clients License Usage for pool')) {
                const poolData = licenseUsage[poolName];
                        for (const client of poolData) {
                            if (client.Hostname === 'TOTAL') {
                                totalApUsed += parseInt(client.AP || 0);
                                totalPefUsed += parseInt(client.PEF || 0);
                                totalRfpUsed += parseInt(client['RF Protect'] || 0);
                                totalMmUsed += parseInt(client.MM || 0);
                                totalMcvaUsed += parseInt(client['MC-VA-RW'] || 0);
                            } else {
                                // 计算非TOTAL行的客户端数量
                                totalClients += 1;
                            }
                        }
            }
        }
        
        // 获取Total Installed值
        let apInstalled = 0;
        let pefInstalled = 0;
        let rfpInstalled = 0;
        let mmInstalled = 0;
        let mcvaInstalled = 0;
        
        // 从license_summary中提取Total Installed值
        if (licenseSummary && typeof licenseSummary === 'object') {
            // 检查是否有License Summary数组
            if (licenseSummary['License Summary'] && Array.isArray(licenseSummary['License Summary'])) {
                // 遍历数组查找对应的License类型
                for (const item of licenseSummary['License Summary']) {
                    if (item.License === 'AP') {
                        apInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'PEFNG') {
                        pefInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'RFP') {
                        rfpInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'MM') {
                        mmInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'MC-VA-RW') {
                        mcvaInstalled = parseInt(item['Total Installed'] || 0);
                    }
                }
            } else if (Array.isArray(licenseSummary)) {
                // 直接是数组格式
                for (const item of licenseSummary) {
                    if (item.License === 'AP') {
                        apInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'PEFNG') {
                        pefInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'RFP') {
                        rfpInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'MM') {
                        mmInstalled = parseInt(item['Total Installed'] || 0);
                    } else if (item.License === 'MC-VA-RW') {
                        mcvaInstalled = parseInt(item['Total Installed'] || 0);
                    }
                }
            } else {
                // 查找包含Total Installed信息的行
                for (const key in licenseSummary) {
                    const value = licenseSummary[key];
                    if (typeof value === 'string') {
                        // 解析类似 "AP: 100 (Total Installed: 100)" 的格式
                        const apMatch = value.match(/AP:\s*(\d+).*Total Installed:\s*(\d+)/);
                        if (apMatch) {
                            apInstalled = parseInt(apMatch[2]);
                        }
                        
                        const pefMatch = value.match(/PEFNG:\s*(\d+).*Total Installed:\s*(\d+)/);
                        if (pefMatch) {
                            pefInstalled = parseInt(pefMatch[2]);
                        }
                        
                        const rfpMatch = value.match(/RFP:\s*(\d+).*Total Installed:\s*(\d+)/);
                        if (rfpMatch) {
                            rfpInstalled = parseInt(rfpMatch[2]);
                        }
                        
                        const mmMatch = value.match(/MM:\s*(\d+).*Total Installed:\s*(\d+)/);
                        if (mmMatch) {
                            mmInstalled = parseInt(mmMatch[2]);
                        }
                        
                        const mcvaMatch = value.match(/MC-VA-RW:\s*(\d+).*Total Installed:\s*(\d+)/);
                        if (mcvaMatch) {
                            mcvaInstalled = parseInt(mcvaMatch[2]);
                        }
                    }
                }
            }
        }
        
        // 计算可用数量
        const apAvailable = Math.max(0, apInstalled - totalApUsed);
        const pefAvailable = Math.max(0, pefInstalled - totalPefUsed);
        const rfpAvailable = Math.max(0, rfpInstalled - totalRfpUsed);
        const mmAvailable = Math.max(0, mmInstalled - totalMmUsed);
        const mcvaAvailable = Math.max(0, mcvaInstalled - totalMcvaUsed);
        
        // 更新页面显示
        document.getElementById('apAvailable').textContent = apAvailable;
        document.getElementById('pefAvailable').textContent = pefAvailable;
        document.getElementById('rfpAvailable').textContent = rfpAvailable;
        document.getElementById('mmAvailable').textContent = mmAvailable;
        document.getElementById('mcvaAvailable').textContent = mcvaAvailable;
        document.getElementById('totalClients').textContent = totalClients;
        
        console.log('License摘要更新完成:', {
            ap: {installed: apInstalled, used: totalApUsed, available: apAvailable},
            pef: {installed: pefInstalled, used: totalPefUsed, available: pefAvailable},
            rfp: {installed: rfpInstalled, used: totalRfpUsed, available: rfpAvailable},
            mm: {installed: mmInstalled, used: totalMmUsed, available: mmAvailable},
            mcva: {installed: mcvaInstalled, used: totalMcvaUsed, available: mcvaAvailable},
            totalClients: totalClients
        });
        
        console.log('调试信息:', {
            licenseUsage: licenseUsage,
            licenseSummary: licenseSummary,
            licenseSummaryType: typeof licenseSummary,
            hasLicenseSummary: licenseSummary && licenseSummary['License Summary']
        });
        
    } catch (error) {
        console.error('计算License摘要失败:', error);
    }
}
</script>
{% endblock %}
